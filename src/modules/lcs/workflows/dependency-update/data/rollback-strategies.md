# Rollback Strategies per Package Manager

## Purpose

Defines the update and rollback strategy for each supported package manager. Used by step-02-plan and step-03-approve-execute to adapt execution commands.

---

## Composer (PHP)

### Update Command
```bash
composer require {package}:{version} --no-interaction
```

### Lock File
- `composer.lock` — auto-generated by composer require/update

### Rollback Strategy
- **Before update:** `git add composer.json composer.lock && git commit -m "pre-update: {package}"`
- **After successful update:** `git add composer.json composer.lock && git commit -m "update: {package} {from} → {to}"`
- **On failure:** `git revert HEAD --no-edit`

### Safety Net Validation
```bash
composer validate
composer install --dry-run
# Then run Playwright safety nets
```

### Notes
- Composer 2.x handles dependency resolution well
- Watch for PHP version constraints in `composer.json`
- Some packages have post-install scripts that may fail silently

---

## NPM (Node.js)

### Update Command
```bash
npm install {package}@{version} --save
```

### Lock File
- `package-lock.json` — auto-generated by npm install

### Rollback Strategy
- **Before update:** `git add package.json package-lock.json && git commit -m "pre-update: {package}"`
- **After successful update:** `git add package.json package-lock.json && git commit -m "update: {package} {from} → {to}"`
- **On failure:** `git revert HEAD --no-edit`

### Safety Net Validation
```bash
npm ci --dry-run
npm audit
# Then run Playwright safety nets
```

### Notes
- Prefer `npm install` over `npm update` for single packages (more predictable)
- `package-lock.json` changes can be large — commit individually
- Watch for peer dependency warnings

---

## Yarn (Node.js)

### Update Command
```bash
yarn upgrade {package}@{version}
```

### Lock File
- `yarn.lock` — auto-generated by yarn upgrade

### Rollback Strategy
- **Before update:** `git add package.json yarn.lock && git commit -m "pre-update: {package}"`
- **After successful update:** `git add package.json yarn.lock && git commit -m "update: {package} {from} → {to}"`
- **On failure:** `git revert HEAD --no-edit`

### Safety Net Validation
```bash
yarn check --integrity
yarn audit
# Then run Playwright safety nets
```

### Notes
- Yarn Classic (1.x) vs Yarn Berry (2+) have different behaviors
- Berry uses `yarn up` instead of `yarn upgrade`
- Check `.yarnrc.yml` for configuration

---

## General Principles

1. **Always commit lock files with manifest files** — never commit one without the other
2. **One package per commit** — enables surgical rollback via `git revert`
3. **Validate before committing** — run package manager validation + safety nets
4. **Never force-update** — if dependency resolution fails, skip and flag for manual review
5. **Preserve existing constraints** — update to compatible versions within existing semver ranges first, then evaluate major bumps separately
